<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIA Manager - Full Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
	/* Titoli delle Sezioni Grandi */
.section-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 40px 0 20px 0;
    padding-bottom: 10px;
    border-bottom: 2px solid #333;
}

.section-header h2 {
    margin: 0;
    font-size: 1.5rem;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 2px;
}

/* Menu di Navigazione Rapida */
.nav-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
    background: #1e1e24;
    padding: 10px;
    border-radius: 12px;
    position: sticky; /* Rimane in alto quando scorri! */
    top: 10px;
    z-index: 100;
    border: 1px solid #333;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
}

.nav-link {
    flex: 1;
    text-align: center;
    background: transparent;
    color: #aaa;
    text-decoration: none;
    padding: 10px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 0.9rem;
    transition: all 0.2s;
}

.nav-link:hover {
    background: #333;
    color: white;
}

/* Colori specifici per i bottoni */
.nav-link.finance:hover { background: rgba(0, 184, 148, 0.2); color: #00b894; }
.nav-link.school:hover { background: rgba(108, 92, 231, 0.2); color: #6c5ce7; }

	/* --- CALCOLATRICE FLUTTUANTE --- */
.calc-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9990; /* Sopra a tutto, ma sotto i modali */
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 10px;
}

/* Il Tasto Rotondo per aprire/chiudere */
.calc-toggle-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--accent); /* Usa il colore principale del tuo tema */
    color: white;
    font-size: 1.8rem;
    border: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: transform 0.2s;
}
.calc-toggle-btn:hover { transform: scale(1.1); }

/* Il Corpo della Calcolatrice (Nascosto all'inizio) */
.calculator-body {
    display: none; /* Nascosto di default */
    background: rgba(30, 30, 36, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid #444;
    padding: 15px;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.6);
    width: 260px;
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Display */
.calc-display {
    width: 100%;
    height: 50px;
    background: #111;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1.5rem;
    text-align: right;
    padding: 10px;
    margin-bottom: 15px;
    box-sizing: border-box; /* Importante per non sbordare */
    font-family: monospace;
}

/* Griglia Tasti */
.calc-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
}

/* Stile Tasti */
.calc-btn {
    padding: 15px;
    border-radius: 12px;
    border: none;
    font-size: 1.2rem;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.1s;
    color: white;
    background: #2d3436;
}
.calc-btn:active { transform: scale(0.95); }

/* Colori specifici */
.btn-op { background: #e17055; } /* Operatori (Arancione) */
.btn-eq { background: #00b894; grid-column: span 2; } /* Uguale (Verde) */
.btn-ac { background: #d63031; color: white; } /* Clear (Rosso) */

        /* --- STILI PRO (SIA DESIGN) --- */
        :root { 
            --bg-color: #121214; 
            --card-bg: #1e1e24; 
            --text-primary: #ffffff; 
            --text-secondary: #a0a0b0;
            --accent: #6c5ce7; /* Viola Business */
            --success: #00b894; /* Verde Deliveroo */
            --danger: #d63031; 
            --warning: #fdcb6e;
            --input-bg: #2d3436;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-primary); 
            margin: 0; 
            padding: 40px 20px; 
            overflow-y: scroll; /* Abilita scroll */
        }

        .container { 
            width: 100%; 
            max-width: 900px; /* Larghezza ottimale per lettura */
            margin: 0 auto; 
            display: flex; 
            flex-direction: column; 
            gap: 30px; /* Spazio tra le sezioni */
            padding-bottom: 100px;
        }

        /* CARD STYLE GENERALE */
        .card { 
            background-color: var(--card-bg); 
            border-radius: 12px; 
            padding: 25px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            border: 1px solid #333;
        }

        h2 { 
            font-size: 1.2rem; 
            font-weight: 800; 
            margin: 0 0 20px 0; 
            color: var(--text-secondary); 
            text-transform: uppercase; 
            letter-spacing: 1px;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }

        /* --- 1. HEADER & WALLET --- */
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #2d3436, #1e1e24);
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid var(--accent);
        }
        .wallet-group { text-align: right; }
        .wallet-label { font-size: 0.8rem; color: var(--text-secondary); display: block; margin-bottom: 5px; }
        .wallet-input { 
            background: transparent; 
            border: none; 
            color: var(--success); 
            font-family: 'Fira Code', monospace; 
            font-size: 2rem; 
            font-weight: bold; 
            text-align: right; 
            width: 250px; 
            outline: none;
            border-bottom: 1px dashed #444; /* Indica che √® modificabile */
        }
        .wallet-input:focus { border-bottom: 1px solid var(--success); }

        /* --- 2. INPUT AREA --- */
        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr 1fr;
            gap: 15px;
            align-items: end;
        }
        label { font-size: 0.75rem; color: #888; margin-bottom: 8px; display: block; }
        input, select { 
            width: 100%; 
            padding: 12px; 
            background: var(--input-bg); 
            border: 1px solid #444; 
            color: white; 
            border-radius: 8px; 
            font-size: 1rem;
            box-sizing: border-box;
        }
        .btn-action { padding: 12px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; transition: transform 0.1s; }
        .btn-action:active { transform: scale(0.98); }
        .bg-inc { background: var(--success); color: #000; }
        .bg-exp { background: var(--danger); color: #fff; }

        /* --- 3. GOALS --- */
        .goal-row {
            display: flex;
            align-items: center;
            background: #25252b;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .goal-info { width: 150px; font-weight: bold; font-size: 0.9rem; }
        .goal-bar-container { flex-grow: 1; height: 12px; background: #111; border-radius: 6px; margin: 0 15px; overflow: hidden; }
        .goal-fill { height: 100%; transition: width 0.5s; background: linear-gradient(90deg, var(--accent), #a29bfe); }
        .goal-nums { font-family: 'Fira Code', monospace; font-size: 0.85rem; color: #aaa; width: 120px; text-align: right; }
        .goal-btn { background: #333; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px; font-size: 0.8rem; }

        /* --- 4. DATA VISUALIZATION --- */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 2fr; /* Torta piccola, Barre grande */
            gap: 20px;
        }
        .chart-box {
            background: #25252b;
            padding: 15px;
            border-radius: 8px;
            height: 300px; /* Altezza fissa per i grafici */
        }

        /* --- 5. TABLE --- */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.95rem; }
        th { text-align: left; color: #666; padding: 10px; border-bottom: 1px solid #333; font-size: 0.8rem; text-transform: uppercase; }
        td { padding: 12px 10px; border-bottom: 1px solid #2a2a2a; }
        tr:hover { background-color: #2a2a30; }
        .tag { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
        .tag-inc { background: rgba(0, 184, 148, 0.15); color: var(--success); }
        .tag-exp { background: rgba(214, 48, 49, 0.15); color: var(--danger); }
        
        .filters { display: flex; gap: 10px; margin-bottom: 15px; }

        /* --- FOOTER --- */
        .footer-tools { display: flex; gap: 15px; margin-top: 20px; border-top: 1px solid #333; padding-top: 20px; justify-content: center; }
        .btn-tool { background: transparent; border: 1px solid #555; color: #888; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .btn-tool:hover { border-color: var(--accent); color: var(--accent); }

        @media (max-width: 768px) {
            .input-grid { grid-template-columns: 1fr; }
            .charts-container { grid-template-columns: 1fr; height: auto; }
            .wallet-input { font-size: 1.5rem; width: 100%; text-align: left; }
            .header-section { flex-direction: column; align-items: flex-start; gap: 15px; }
        }
		
		/* --- STILE DEL MODAL (FINESTRA) --- */
.modal-overlay {
    display: none; /* Nascosto di default */
    position: fixed; /* Fisso sullo schermo */
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.85); /* Sfondo scuro */
    z-index: 9999; /* Sopra a tutto */
    justify-content: center;
    align-items: center;
}

.modal-box {
    background: #1e1e24;
    padding: 20px;
    border-radius: 12px;
    width: 90%;
    max-width: 400px;
    border: 1px solid #444;
    color: white;
    box-shadow: 0 10px 40px rgba(0,0,0,0.8);
    max-height: 90vh; /* Per non uscire dallo schermo se √® piccolo */
    overflow-y: auto; /* Scroll se serve */
}
    </style>
</head>
<body>

<div class="container">

    <div class="header-section">
        <div>
            <h1 style="margin:0; font-size:1.5rem;">Dashboard Finanziaria</h1>
            <span style="color:#666; font-size:0.9rem;">Gestione Economica Personale</span>
        </div>
        <div class="wallet-group">
            <label class="wallet-label">SALDO DISPONIBILE (Modificabile)</label>
            <span>‚Ç¨</span>
            <input type="number" id="walletInput" class="wallet-input" value="0.00" onchange="manualWalletUpdate()">
			<div style="margin-top:15px; padding-top:15px; border-top:1px solid #333;">
    <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#aaa; margin-bottom:5px;">
        <span>üéØ Obiettivo Liquidit√†</span>
        <span id="liquidityText" style="cursor:pointer; text-decoration:underline;" onclick="setLiquidityTarget()">Imposta Target</span>
    </div>
    
    <div style="background:#111; height:8px; border-radius:4px; overflow:hidden;">
        <div id="liquidityBar" style="width:0%; height:100%; background:linear-gradient(90deg, #fdcb6e, #00b894); transition: width 0.5s;"></div>
    </div>
    <div style="text-align:right; font-size:0.75rem; color:#666; margin-top:2px;" id="liquidityPerc">0%</div>
</div>
        </div>
    </div>



    <div class="card">
	<div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="margin:0;">Nuova Transazione</h2>
            
            <button onclick="openModal()" 
                    style="background:none; border:1px solid var(--accent); color:var(--accent); 
                           padding:6px 12px; border-radius:20px; cursor:pointer; font-size:0.75rem; font-weight:bold;">
                üîÅ Modelli / Fisse
            </button>
        </div>
        <div class="input-grid">
            <div>
                <label>Data</label>
                <input type="date" id="dateInput">
            </div>
            <div>
                <label>Categoria</label>
                <select id="catSelect">
                    <option value="üõµ Lavoro (Deliveroo)">üõµ Lavoro (Deliveroo)</option>
					<option value="üëïVinted">üëïVinted</option>
                    <option value="üçï Cibo">üçï Cibo</option>
                    <option value="üéÅ Regali">üéÅ Regali</option>
                    <option value="‚õΩ Benzina">‚õΩ Benzina</option>
                    <option value="üéâ Svago">üéâ Svago</option>
                    <option value="üöó Trasporti">üöó Trasporti</option>
                    <option value="üí∏ Invest/Risp">üí∏ Invest/Risp</option>
					<div style="position: relative; width: 100%; margin-bottom: 15px; height: 45px;">
    
    <select id="catSelect" 
            style="width: 100%; height: 100%; padding: 10px; padding-right: 60px; 
                   border-radius: 8px; border: 1px solid #444; background: #1e1e24; color: white; 
                   appearance: none; -webkit-appearance: none; /* Toglie stile nativo */">
        </select>
    
    <div style="position: absolute; right: 60px; top: 50%; transform: translateY(-50%); color: #888; pointer-events: none; font-size: 0.8rem;">‚ñº</div>

    <button onclick="manageCategories()" 
            style="position: absolute; right: 0; top: 0; bottom: 0; width: 50px; 
                   background: #2d3436; border: 1px solid #444; border-left: none; 
                   border-top-right-radius: 8px; border-bottom-right-radius: 8px; 
                   cursor: pointer; font-size: 1.2rem; display: flex; justify-content: center; align-items: center;">
        ‚öôÔ∏è
    </button>

</div>
                </select>
            </div>
            <div>
                <label>Descrizione</label>
                <input type="text" id="descInput" placeholder="Dettaglio...">
            </div>
            <div>
                <label>Importo</label>
                <input type="number" id="amountInput" placeholder="0.00">
            </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn-action bg-inc" style="flex:1" onclick="addTransaction('income')">AGGIUNGI ENTRATA</button>
            <button class="btn-action bg-exp" style="flex:1" onclick="addTransaction('expense')">AGGIUNGI USCITA</button>
        </div>
    </div>

    <div class="card">
        <h2>üéØ Obiettivi di Risparmio <button class="btn-tool" style="font-size:0.7rem; padding:4px 8px;" onclick="createGoal()">+ Nuovo</button></h2>
        <div id="goalsContainer">
            </div>
    </div>

    <div class="card">
        <div class="filters">
            <h2 style="margin:0; width:100%;">Analisi Finanziaria</h2>
            <input type="month" id="monthFilter" style="width:auto; background:#111;" onchange="renderCharts()">
        </div>
        
        <div class="charts-container">
            <div class="chart-box">
                <div style="text-align:center; margin-bottom:10px; color:#aaa; font-size:0.8rem;">RIPARTIZIONE SPESE (Mese)</div>
                <canvas id="monthlyChart"></canvas>
            </div>
            <div class="chart-box">
                <div style="text-align:center; margin-bottom:10px; color:#aaa; font-size:0.8rem;">ANDAMENTO ANNUALE (Entrate vs Uscite)</div>
                <canvas id="annualChart"></canvas>
            </div>
        </div>
        <div id="statsRow" style="display:flex; justify-content:space-around; margin-top:20px; text-align:center; border-top:1px solid #333; padding-top:15px;">
            <div>
                <div style="font-size:0.8rem; color:#888;">ENTRATE MESE</div>
                <div id="monthIncVal" style="color:var(--success); font-weight:bold; font-size:1.2rem;">‚Ç¨0</div>
            </div>
            <div>
                <div style="font-size:0.8rem; color:#888;">USCITE MESE</div>
                <div id="monthExpVal" style="color:var(--danger); font-weight:bold; font-size:1.2rem;">‚Ç¨0</div>
            </div>
            <div>
                <div style="font-size:0.8rem; color:#888;">RISPARMIO MESE</div>
                <div id="monthNetVal" style="color:white; font-weight:bold; font-size:1.2rem;">‚Ç¨0</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>üìù Registro Movimenti</h2>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th width="15%">Data</th>
                        <th width="20%">Categoria</th>
                        <th width="40%">Descrizione</th>
                        <th width="15%">Importo</th>
                        <th width="10%">Azioni</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

<div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2 style="margin:0;">üçÖ Focus Session</h2>
        <div id="timerStatus" style="font-size:0.8rem; color:#666; font-weight:bold; letter-spacing:1px;">PRONTO</div>
    </div>

    <div style="display:flex; gap:20px; flex-wrap:wrap;">
        
        <div style="flex:1; min-width:200px; text-align:center; background:#2d3436; padding:20px; border-radius:12px; border:1px solid #444;">
            <div id="focusDisplay" style="font-size: 3.5rem; font-family: 'Fira Code', monospace; font-weight: 800; color: white; line-height: 1; margin-bottom: 15px;">
                25:00
            </div>
            
            <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom:15px;">
                <button onclick="adjustTime(-5)" style="background:none; border:none; color:#666; font-size:1.2rem; cursor:pointer;">-</button>
                <input type="number" id="focusDuration" value="25" onchange="manualTimeSet()" 
                       style="width:100px; text-align:center; background:none; border:none; color:white; font-size:1.2rem; font-weight:bold;">
                <span style="color:#666;">min</span>
                <button onclick="adjustTime(+5)" style="background:none; border:none; color:#666; font-size:1.2rem; cursor:pointer;">+</button>
            </div>

            <div style="display:flex; gap:10px; justify-content:center;">
                <button id="btnStartFocus" onclick="startFocus()" 
                        style="background:var(--accent); color:white; border:none; padding:10px 25px; border-radius:8px; font-weight:bold; cursor:pointer;">
                    ‚ñ∂ START
                </button>
                <button id="btnPauseFocus" onclick="pauseFocus()" style="display:none; background:var(--warning); color:black; border:none; padding:10px 25px; border-radius:8px; font-weight:bold; cursor:pointer;">
                    ‚è∏ PAUSA
                </button>
                <button onclick="resetFocus()" style="background:#444; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer;">‚Ü∫</button>
            </div>
        </div>

        <div style="flex:1.5; min-width:250px;">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="newFocusTask" placeholder="Scrivi obiettivo e premi Invio..." 
                       onkeypress="if(event.key === 'Enter') addFocusTask()"
                       style="flex:1; padding:10px; border-radius:6px; border:1px solid #555; background:#1e1e24; color:white;">
                <button onclick="addFocusTask()" style="background:#444; color:white; border:none; padding:0 15px; border-radius:6px; cursor:pointer; font-weight:bold;">+</button>
            </div>

            <div id="focusTodoList" style="display:flex; flex-direction:column; gap:8px; max-height:200px; overflow-y:auto;">
                </div>
            
            <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center; font-size:0.8rem; color:#888;">
                <span id="tasksCount">0 obiettivi</span>
                <button onclick="clearFocusList()" style="background:none; border:none; color:#d63031; cursor:pointer; font-size:0.75rem;">Pulisci tutto</button>
            </div>
        </div>

    </div>
</div>
<div class="card" style="margin-top: 20px;">
    <h2 style="border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px;">üß† Skills & Obiettivi</h2>
    
    <div style="background:#2d3436; padding:10px; border-radius:10px; margin-bottom:20px; border:1px solid #444;">
        <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">Nuovo Obiettivo</div>
        
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <input type="text" id="skillName" placeholder="Nome (es. Libro, Corsa)" 
                   style="flex: 2; min-width:120px; padding: 10px; border-radius: 6px; border: 1px solid #444; background: #1e1e24; color: white;">
            
            <input type="number" id="skillTarget" placeholder="Obiettivo (es. 300)" 
                   style="flex: 1; min-width:80px; padding: 10px; border-radius: 6px; border: 1px solid #444; background: #1e1e24; color: white;">
            
            <input type="text" id="skillUnit" placeholder="Unit (es. km)" 
                   style="flex: 1; min-width:60px; padding: 10px; border-radius: 6px; border: 1px solid #444; background: #1e1e24; color: white;">
            
            <button onclick="addSkill()" 
                    style="width: 50px; background: var(--success); border: none; border-radius: 6px; color: white; font-size: 1.5rem; cursor: pointer; font-weight: bold;">+</button>
        </div>
    </div>

    <div id="skillsList" style="display: flex; flex-direction: column; gap: 15px;">
        </div>
</div>

<div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h2 style="margin:0;">üéì Registro Voti</h2>
            <div style="font-size:0.8rem; background:#111; padding:5px 10px; border-radius:6px; border:1px solid #444;">
                <span style="color:#888;">Media Totale:</span> 
                <span id="globalGpa" style="color:white; font-weight:bold; font-size:1rem;">0.0</span>
            </div>
        </div>

        <div style="background:#2d3436; padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid #444;">
            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 0.5fr; gap: 10px; align-items: end;">
                
                <div>
                    <label>Materia</label>
                    <input type="text" id="subjectInput" list="subjectListSuggestions" placeholder="Es. Storia">
                    <datalist id="subjectListSuggestions">
                        </datalist>
                </div>

                <div>
                    <label>Voto</label>
                    <input type="number" id="gradeInput" step="0.25" placeholder="Es. 8.5">
                </div>

                <div>
                    <label>Periodo</label>
                    <select id="termSelect">
                        <option value="1">1¬∞ Quad</option>
                        <option value="2">2¬∞ Quad</option>
                    </select>
                </div>

                <button onclick="addGrade()" style="height: 42px; background: var(--accent); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">+</button>
            </div>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <div style="flex:1; background:#1e1e24; border:1px solid #333; padding:10px; border-radius:8px; text-align:center;">
                <div style="font-size:0.75rem; color:#aaa;">MEDIA 1¬∞ Q.</div>
                <div id="gpaQ1" style="font-size:1.2rem; font-weight:bold; color:var(--warning);">0.0</div>
            </div>
            <div style="flex:1; background:#1e1e24; border:1px solid #333; padding:10px; border-radius:8px; text-align:center;">
                <div style="font-size:0.75rem; color:#aaa;">MEDIA 2¬∞ Q.</div>
                <div id="gpaQ2" style="font-size:1.2rem; font-weight:bold; color:var(--success);">0.0</div>
            </div>
        </div>

        <div id="schoolList" style="display: flex; flex-direction: column; gap: 10px;">
            </div>
    </div>

    <div class="footer-tools">
        <button class="btn-tool" onclick="exportCSV()">üìÑ Scarica Excel (.CSV)</button>
        <button class="btn-tool" onclick="downloadJSON()">üíæ Backup Dati</button>
        <input type="file" id="fileUpload" style="display:none" onchange="uploadJSON(this)">
        <button class="btn-tool" onclick="document.getElementById('fileUpload').click()">üìÇ Ripristina Backup</button>
        <button class="btn-tool" style="border-color:var(--danger); color:var(--danger)" onclick="hardReset()">‚ö†Ô∏è Reset</button>
    </div>

</div>

<div id="recurringModal" class="modal-overlay">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:15px;">
            <h3 style="margin:0;">üîÅ Gestione Ricorrenti</h3>
            <button onclick="closeModal()" style="background:none; border:none; color:white; font-size:1.5rem;">&times;</button>
        </div>

        <div id="recList" style="margin-bottom:20px; max-height:200px; overflow-y:auto; border:1px solid #333; padding:5px; border-radius:5px; background:#111;">
            </div>

        <div style="background:#2d3436; padding:15px; border-radius:8px;">
            <div style="font-weight:bold; margin-bottom:10px; color:var(--accent);">+ NUOVO MODELLO</div>
            
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <label style="flex:1; background:#111; padding:8px; border-radius:5px; text-align:center; border:1px solid #444;">
                    <input type="radio" name="newRecType" value="expense" checked> üî¥ Uscita
                </label>
                <label style="flex:1; background:#111; padding:8px; border-radius:5px; text-align:center; border:1px solid #444;">
                    <input type="radio" name="newRecType" value="income"> üü¢ Entrata
                </label>
            </div>

            <input type="text" id="newRecName" placeholder="Nome (es. Affitto, Mancia)" style="width:100%; padding:8px; margin-bottom:8px; box-sizing:border-box;">
            
            <select id="newRecCat" style="width:100%; padding:8px; margin-bottom:8px; box-sizing:border-box;">
                <option value="üõµ Lavoro (Deliveroo)">üõµ Lavoro (Deliveroo)</option>
					<option value="üëïVinted">üëïVinted</option>
                    <option value="üçï Cibo">üçï Cibo</option>
                    <option value="üéÅ Regali">üéÅ Regali</option>
                    <option value="‚õΩ Benzina">‚õΩ Benzina</option>
                    <option value="üéâ Svago">üéâ Svago</option>
                    <option value="üöó Trasporti">üöó Trasporti</option>
                    <option value="üí∏ Invest/Risp">üí∏ Invest/Risp</option>
					<option value="üì¶ Altro">üì¶ Altro</option>
            </select>

            <div style="display:flex; gap:10px;">
                <input type="number" id="newRecAmount" placeholder="‚Ç¨ Importo" style="flex:1; padding:8px;">
                <button onclick="addRecModel()" style="flex:1; background:var(--success); border:none; border-radius:5px; font-weight:bold;">SALVA</button>
            </div>
        </div>
    </div>
</div>

<div class="calc-widget">
    
    <div id="calcBody" class="calculator-body">
        <input type="text" id="calcDisplay" class="calc-display" readonly placeholder="0">
        
        <div class="calc-grid">
            <button class="calc-btn btn-ac" onclick="calcClear()">AC</button>
            <button class="calc-btn btn-op" onclick="calcAppend('/')">√∑</button>
            <button class="calc-btn btn-op" onclick="calcAppend('*')">√ó</button>
            <button class="calc-btn" onclick="calcDelete()">‚å´</button>

            <button class="calc-btn" onclick="calcAppend('7')">7</button>
            <button class="calc-btn" onclick="calcAppend('8')">8</button>
            <button class="calc-btn" onclick="calcAppend('9')">9</button>
            <button class="calc-btn btn-op" onclick="calcAppend('-')">-</button>

            <button class="calc-btn" onclick="calcAppend('4')">4</button>
            <button class="calc-btn" onclick="calcAppend('5')">5</button>
            <button class="calc-btn" onclick="calcAppend('6')">6</button>
            <button class="calc-btn btn-op" onclick="calcAppend('+')">+</button>

            <button class="calc-btn" onclick="calcAppend('1')">1</button>
            <button class="calc-btn" onclick="calcAppend('2')">2</button>
            <button class="calc-btn" onclick="calcAppend('3')">3</button>
            <button class="calc-btn" onclick="calcAppend('0')">0</button>
            <button class="calc-btn" onclick="calcAppend('.')">.</button>
            <button class="calc-btn btn-eq" onclick="calcCalculate()">=</button>
        </div>
    </div>

    <button class="calc-toggle-btn" onclick="toggleCalculator()" title="Apri Calcolatrice">
        üßÆ
    </button>
</div>
<script>
    // --- GESTIONE DATI ---
    const DB_KEY = 'SIA_Finance_v9';
    
    // Struttura dati iniziale
    // Aggiungo school: [] direttamente qui per i nuovi utenti
    let appData = JSON.parse(localStorage.getItem(DB_KEY)) || {
        wallet: 0,
        transactions: [],
        school: [], // <--- Aggiunto qui per sicurezza
        goals: [
            { id: 1, name: "Tasse Uni", target: 2000, current: 500 },
            { id: 2, name: "Motorino", target: 1200, current: 200 }
        ]
    };

    let chartInstances = { monthly: null, annual: null };

    // --- CORE LOGIC ---
    function saveData() {
        localStorage.setItem(DB_KEY, JSON.stringify(appData));
        refreshUI();
    }

    // --- QUESTA √à L'UNICA FUNZIONE REFRESHUI CHE DEVI AVERE ---
    function refreshUI() {
        // 1. Controllo di sicurezza (Ripara i dati se manca la scuola)
        if (!appData.school) {
            appData.school = [];
        }

        // 2. Aggiornamento Wallet
        if (document.getElementById('walletInput')) {
            document.getElementById('walletInput').value = parseFloat(appData.wallet).toFixed(2);
        }

        // 3. Render di tutte le sezioni
        // (Uso typeof per evitare errori se non hai ancora copiato le altre funzioni)
        if (typeof renderGoals === 'function') renderGoals();
        if (typeof renderTable === 'function') renderTable();
        if (typeof renderCharts === 'function') renderCharts();
        if (typeof renderSkills === 'function') renderSkills();
        
        // 4. SCUOLA (Fondamentale)
        renderSchool(); 
    }

    // --- INIT (Avvio dell'App) ---
    // Queste righe partono appena apri la pagina
    
    // Se hai queste funzioni nel tuo codice, lasciale qui:
    if (typeof renderCategoryOptions === 'function') renderCategoryOptions();
    if (typeof renderLiquidity === 'function') renderLiquidity(); 

    // Imposta le date
    const dateInput = document.getElementById('dateInput');
    if (dateInput) dateInput.valueAsDate = new Date();
    
    const monthFilter = document.getElementById('monthFilter');
    if (monthFilter) monthFilter.value = new Date().toISOString().slice(0, 7);

    // Lancia la grafica finale!
    refreshUI();

    // 1. GESTIONE WALLET MANUALE
    function manualWalletUpdate() {
        const val = parseFloat(document.getElementById('walletInput').value);
        if (!isNaN(val)) {
            appData.wallet = val;
            saveData();
        }
    }
    
    // ... qui sotto continua il resto del tuo codice ...

    // 2. TRANSAZIONI
    function addTransaction(type) {
        const date = document.getElementById('dateInput').value;
        const cat = document.getElementById('catSelect').value;
        const desc = document.getElementById('descInput').value || cat;
        const amt = parseFloat(document.getElementById('amountInput').value);

        if (!amt) { alert("Inserisci un importo valido"); return; }

        appData.transactions.push({
            id: Date.now(),
            date: date,
            category: cat,
            desc: desc,
            amount: amt,
            type: type
        });

        // Aggiorna wallet calcolato
        if(type === 'income') appData.wallet += amt;
        else appData.wallet -= amt;

        // Pulisci campi
        document.getElementById('amountInput').value = '';
        document.getElementById('descInput').value = '';
        
        saveData();
    }

    function deleteTransaction(id) {
        if(confirm("Eliminare movimento?")) {
            const t = appData.transactions.find(x => x.id === id);
            if(t) {
                // Storno importo
                if(t.type === 'income') appData.wallet -= t.amount;
                else appData.wallet += t.amount;
                
                appData.transactions = appData.transactions.filter(x => x.id !== id);
                saveData();
            }
        }
    }

    // 3. GOALS
    function createGoal() {
        const name = prompt("Nome Obiettivo (es. Assicurazione):");
        const target = parseFloat(prompt("Importo Target (‚Ç¨):"));
        if (name && target) {
            appData.goals.push({ id: Date.now(), name: name, target: target, current: 0 });
            saveData();
        }
    }

    function updateGoal(id, amount) {
        const g = appData.goals.find(x => x.id === id);
        if (g) {
            g.current += amount;
            if(g.current < 0) g.current = 0;
            saveData();
        }
    }
    
    function deleteGoal(id) {
        if(confirm("Rimuovere obiettivo?")) {
            appData.goals = appData.goals.filter(x => x.id !== id);
            saveData();
        }
    }

    // --- FUNZIONI OBIETTIVI (GOALS) ---

    // 1. Mostra gli obiettivi e i pulsanti + / -
    function renderGoals() {
        const container = document.getElementById('goalsContainer');
        container.innerHTML = ''; // Pulisce la lista
        
        // Se non ci sono obiettivi, non fa nulla
        if(!appData.goals) return;

        appData.goals.forEach(g => {
            // Calcolo percentuale barra (evita errori se target √® 0)
            let perc = 0;
            if(g.target > 0) perc = Math.min(100, (g.current / g.target) * 100).toFixed(1);
            
            // Genera l'HTML
            container.innerHTML += `
                <div class="goal-row">
                    <div class="goal-info">${g.name}</div>
                    
                    <div class="goal-bar-container">
                        <div class="goal-fill" style="width:${perc}%"></div>
                    </div>
                    
                    <div class="goal-nums">‚Ç¨${parseFloat(g.current).toFixed(2)} / ${g.target}</div>
                    
                    <div style="display:flex; gap:5px; margin-left:10px;">
                        <button class="goal-btn" style="background:var(--success); color:#000; font-weight:bold; width:30px;" 
                                onclick="modifyGoal(${g.id}, 'add')">+</button>
                                
                        <button class="goal-btn" style="background:#e17055; color:#fff; font-weight:bold; width:30px;" 
                                onclick="modifyGoal(${g.id}, 'sub')">-</button>
                                
                        <button class="goal-btn" style="background:none; border:1px solid #444; color:#666;" 
                                onclick="deleteGoal(${g.id})">x</button>
                    </div>
                </div>
            `;
        });
    }

    // 2. La funzione che fa i calcoli (AGGIUNGI o TOGLI)
    function modifyGoal(id, action) {
        // Testo diverso per far capire che stiamo spostando soldi
        const text = action === 'add' ? "Quanto vuoi SPOSTARE nel fondo?" : "Quanto vuoi RIPORTARE nel portafoglio?";
        const input = prompt(text);

        if (input !== null && input !== "") {
            const amount = parseFloat(input.replace(',', '.'));

            if (!isNaN(amount) && amount > 0) {
                const goal = appData.goals.find(g => g.id === id);
                
                if (goal) {
                    if (action === 'add') {
                        // LOGICA GIROCONTO (Verso Obiettivo)
                        
                        // 1. Controlliamo se hai abbastanza soldi nel saldo (Opzionale, ma consigliato)
                        if(appData.wallet < amount) {
                            if(!confirm("Attenzione: Il tuo saldo andr√† in negativo. Continuare?")) return;
                        }

                        goal.current += amount;   // Aumenta l'obiettivo
                        appData.wallet -= amount; // SCALA dal saldo disponibile
                        
                    } else {
                        // LOGICA GIROCONTO (Verso Portafoglio / Correzione)
                        
                        // Controllo per non togliere pi√π di quello che c'√® nel fondo
                        if(amount > goal.current) {
                            alert("Non ci sono abbastanza soldi in questo fondo!");
                            return;
                        }

                        goal.current -= amount;   // Diminuisce l'obiettivo
                        appData.wallet += amount; // RITORNA al saldo disponibile
                    }
                    
                    saveData(); // Aggiorna graficamente sia la barra che il saldo in alto
                }
            } else {
                alert("Inserisci un numero valido!");
            }
        }
    }

    // 3. Funzione per creare un nuovo obiettivo (collegata al tasto + Nuovo)
    function createGoal() {
        const name = prompt("Nome Obiettivo (es. Assicurazione):");
        if (!name) return; // Se annulli, esce

        const targetStr = prompt("Importo Target (‚Ç¨):");
        const target = parseFloat(targetStr.replace(',', '.'));

        if (name && target && !isNaN(target)) {
            appData.goals.push({ id: Date.now(), name: name, target: target, current: 0 });
            saveData();
        } else {
            alert("Dati non validi!");
        }
    }

    // 4. Funzione per eliminare un obiettivo
    function deleteGoal(id) {
        if(confirm("Sei sicuro di voler eliminare questo obiettivo?")) {
            appData.goals = appData.goals.filter(x => x.id !== id);
            saveData();
        }
    }

    // 4. TABELLA & FILTRI
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        // Ordina per data decrescente
        const sorted = [...appData.transactions].sort((a,b) => new Date(b.date) - new Date(a.date));
        
        // Mostra ultimi 50 movimenti per performance, o tutti se necessario
        sorted.slice(0, 100).forEach(t => {
            const tagClass = t.type === 'income' ? 'tag-inc' : 'tag-exp';
            const sign = t.type === 'income' ? '+' : '-';
            
            tbody.innerHTML += `
                <tr>
                    <td>${t.date}</td>
                    <td><span class="tag ${tagClass}">${t.category}</span></td>
                    <td style="color:#ccc;">${t.desc}</td>
                    <td style="font-family:'Fira Code'; font-weight:bold; color:${t.type==='income'?'var(--success)':'var(--danger)'}">
                        ${sign} ‚Ç¨${t.amount.toFixed(2)}
                    </td>
                    <td><button onclick="deleteTransaction(${t.id})" style="background:none; border:none; color:#555; cursor:pointer;">üóëÔ∏è</button></td>
                </tr>
            `;
        });
    }

    // 5. CHARTS LOGIC (SIA ANALYTICS)
    function renderCharts() {
        const selectedMonth = document.getElementById('monthFilter').value; // es "2023-10"
        const selectedYear = selectedMonth.split('-')[0];

        // --- CALCOLI MENSILI ---
        let monthInc = 0, monthExp = 0;
        let catExp = {};
        
        appData.transactions.forEach(t => {
            if (t.date.startsWith(selectedMonth)) {
                if (t.type === 'income') monthInc += t.amount;
                else {
                    monthExp += t.amount;
                    catExp[t.category] = (catExp[t.category] || 0) + t.amount;
                }
            }
        });

        // Update Stats Text
        document.getElementById('monthIncVal').innerText = `‚Ç¨ ${monthInc.toFixed(2)}`;
        document.getElementById('monthExpVal').innerText = `‚Ç¨ ${monthExp.toFixed(2)}`;
        document.getElementById('monthNetVal').innerText = `‚Ç¨ ${(monthInc - monthExp).toFixed(2)}`;

        // Draw Monthly Chart (Doughnut)
        // Draw Monthly Chart (Doughnut)
        const ctxM = document.getElementById('monthlyChart').getContext('2d');
        if(chartInstances.monthly) chartInstances.monthly.destroy();
        
        chartInstances.monthly = new Chart(ctxM, {
            type: 'doughnut',
            data: {
                labels: Object.keys(catExp),
                datasets: [{
                    data: Object.values(catExp),
                    backgroundColor: ['#ff7675', '#74b9ff', '#55efc4', '#a29bfe', '#ffeaa7', '#fab1a0', '#e17055', '#00cec9'],
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        position: 'right', 
                        labels: { 
                            color: '#aaa', 
                            font: {size: 11},
                            boxWidth: 12
                        } 
                    },
                    // --- QUESTA √à LA PARTE NUOVA PER LE PERCENTUALI ---
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                let value = context.raw;
                                let total = context.chart._metasets[context.datasetIndex].total;
                                let percentage = ((value / total) * 100).toFixed(1) + "%";
                                return label + ": ‚Ç¨" + value.toFixed(2) + " (" + percentage + ")";
                            }
                        }
                    }
                } 
            }
        });

        // --- CALCOLI ANNUALI ---
        let annualInc = new Array(12).fill(0);
        let annualExp = new Array(12).fill(0);

        appData.transactions.forEach(t => {
            if (t.date.startsWith(selectedYear)) {
                const mIndex = new Date(t.date).getMonth();
                if (t.type === 'income') annualInc[mIndex] += t.amount;
                else annualExp[mIndex] += t.amount;
            }
        });

        // Draw Annual Chart (Bar)
        const ctxA = document.getElementById('annualChart').getContext('2d');
        if(chartInstances.annual) chartInstances.annual.destroy();
        chartInstances.annual = new Chart(ctxA, {
            type: 'bar',
            data: {
                labels: ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'],
                datasets: [
                    { label: 'Entrate', data: annualInc, backgroundColor: '#00b894' },
                    { label: 'Uscite', data: annualExp, backgroundColor: '#d63031' }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, grid: { color: '#333' } },
                    x: { grid: { display: false } }
                },
                plugins: { legend: { labels: { color: '#ccc' } } }
            }
        });
    }

    // 6. EXPORT / IMPORT
    function exportCSV() {
        let csv = "ID,Data,Categoria,Descrizione,Tipo,Importo\n";
        appData.transactions.forEach(t => {
            csv += `${t.id},${t.date},${t.category},${t.desc},${t.type},${t.amount}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Report_SIA_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
    }

    function downloadJSON() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
        const a = document.createElement('a');
        a.href = dataStr;
        a.download = "backup_sia.json";
        a.click();
    }

    function uploadJSON(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                appData = JSON.parse(e.target.result);
                saveData();
                alert("Database ripristinato con successo.");
            } catch(err) { alert("File non valido."); }
        };
        reader.readAsText(file);
    }
    
    function hardReset() {
        if(confirm("SEI SICURO? Canceller√† tutti i dati.")) {
            localStorage.removeItem(DB_KEY);
            location.reload();
        }
    }
	
	// --- GESTIONE RICORRENTI (SISTEMA DEFINITIVO) ---

// Funzioni Apertura/Chiusura Finestra
function openModal() {
    renderRecList(); // Carica i dati aggiornati
    document.getElementById('recurringModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('recurringModal').style.display = 'none';
}

// Funzione per mostrare la lista
function renderRecList() {
    const list = document.getElementById('recList');
    list.innerHTML = '';
    
    // Inizializza se vuoto
    if(!appData.recurring) appData.recurring = [];

    if(appData.recurring.length === 0) {
        list.innerHTML = '<div style="text-align:center; color:#666; padding:10px;">Nessun modello salvato.</div>';
        return;
    }

    appData.recurring.forEach(item => {
        const isInc = item.type === 'income';
        const color = isInc ? '#55efc4' : '#ff7675'; // Verde o Rosso
        const btnText = isInc ? 'INCASSA' : 'PAGA';
        
        list.innerHTML += `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #333;">
                <div>
                    <div style="font-weight:bold; color:${color}">${item.name}</div>
                    <div style="font-size:0.8rem; color:#aaa;">${item.category} ‚Ä¢ ‚Ç¨${item.amount}</div>
                </div>
                <div style="display:flex; gap:5px;">
                    <button onclick="execRec(${item.id})" style="background:${color}; color:#000; border:none; padding:5px 10px; border-radius:4px; font-weight:bold; cursor:pointer;">${btnText}</button>
                    <button onclick="delRec(${item.id})" style="background:none; border:1px solid #555; color:#888; padding:5px 10px; border-radius:4px; cursor:pointer;">üóëÔ∏è</button>
                </div>
            </div>
        `;
    });
}

// Funzione per salvare un nuovo modello
function addRecModel() {
    const name = document.getElementById('newRecName').value;
    const cat = document.getElementById('newRecCat').value;
    const amount = parseFloat(document.getElementById('newRecAmount').value);
    
    // Controlla quale radio button √® selezionato (Entrata o Uscita)
    const typeEl = document.querySelector('input[name="newRecType"]:checked');
    const type = typeEl ? typeEl.value : 'expense';

    if(name && amount) {
        appData.recurring.push({
            id: Date.now(),
            name: name,
            category: cat,
            amount: amount,
            type: type
        });
        
        // Pulisci i campi
        document.getElementById('newRecName').value = '';
        document.getElementById('newRecAmount').value = '';
        
        saveData();
        renderRecList(); // Ricarica la lista visiva
    } else {
        alert("Inserisci Nome e Importo!");
    }
}

// Funzione per ESEGUIRE (Pagare o Incassare)
function execRec(id) {
    const item = appData.recurring.find(x => x.id === id);
    if(item) {
        const today = new Date().toISOString().slice(0, 10);
        
        // Aggiunge la transazione
        appData.transactions.push({
            id: Date.now(),
            date: today,
            category: item.category,
            desc: item.name + ' (Ricorrente)',
            amount: item.amount,
            type: item.type
        });

        // Aggiorna il portafoglio
        if(item.type === 'income') appData.wallet += item.amount;
        else appData.wallet -= item.amount;

        saveData();
        closeModal();
        
        // Aggiorna la schermata principale
        document.getElementById('monthFilter').value = today.slice(0, 7);
        refreshUI();
        
        alert("‚úÖ Operazione registrata con successo!");
    }
}

// Funzione per eliminare modello
function delRec(id) {
    if(confirm("Eliminare questo modello?")) {
        appData.recurring = appData.recurring.filter(x => x.id !== id);
        saveData();
        renderRecList();
    }
}
// --- GESTIONE CATEGORIE DINAMICHE ---

// 1. Inizializza le categorie se √® la prima volta
if (!appData.categories || appData.categories.length === 0) {
    appData.categories = [
        "üè† Casa", "üçî Cibo", "üöó Trasporti", 
        "üõçÔ∏è Shopping", "üéâüéÆ Svago", "üíä Salute", 
        "üí∞ Stipendio", "üéÅ Regalo", "üì¶ Altro"
    ];
}

// 2. Funzione per riempire TUTTI i menu a tendina del sito
function renderCategoryOptions() {
    // Trova tutti i selettori di categoria nel sito (Main, e Modale Ricorrenti)
    const selectors = ['catSelect', 'recCat', 'newRecCat']; // ID dei tuoi select
    
    selectors.forEach(id => {
        const sel = document.getElementById(id);
        if(sel) {
            const currentVal = sel.value; // Ricorda cosa era selezionato
            sel.innerHTML = ''; // Pulisce
            
            appData.categories.forEach(cat => {
                sel.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            
            // Se possibile, rimette il valore che c'era
            if(appData.categories.includes(currentVal)) sel.value = currentVal;
        }
    });
}

// 3. Funzione per Aggiungere/Rimuovere Categorie
function manageCategories() {
    let action = prompt("Scrivi una nuova categoria per aggiungerla (es. 'üê∂ Cane').\nOppure scrivi il nome esatto di una esistente per ELIMINARLA.");
    
    if (action) {
        // Rimuovi spazi extra
        action = action.trim();
        
        // Se esiste gi√†, la eliminiamo
        if (appData.categories.includes(action)) {
            if(confirm(`Vuoi davvero eliminare la categoria "${action}"?`)) {
                appData.categories = appData.categories.filter(c => c !== action);
                alert("üóëÔ∏è Categoria eliminata!");
            }
        } else {
            // Altrimenti la aggiungiamo
            appData.categories.push(action);
            alert("‚úÖ Nuova categoria aggiunta!");
        }
        
        saveData();
        renderCategoryOptions(); // Aggiorna subito i menu
    }
}

// Avvia il caricamento delle categorie all'apertura
renderCategoryOptions();

// --- GESTIONE OBIETTIVO SALDO (LIQUIDIT√Ä) ---

// Funzione per impostare l'obiettivo
function setLiquidityTarget() {
    const current = appData.liquidityTarget || 0;
    const input = prompt("Qual √® il tuo obiettivo di saldo minimo da avere sul conto? (‚Ç¨)", current);
    
    if(input !== null) {
        const val = parseFloat(input.replace(',', '.'));
        if(!isNaN(val) && val >= 0) {
            appData.liquidityTarget = val;
            saveData();
            renderLiquidity();
        }
    }
}

// Funzione per disegnare la barra
function renderLiquidity() {
    const target = appData.liquidityTarget || 1; // Evita divisione per zero
    const current = appData.wallet;
    
    // Calcola percentuale
    let perc = (current / target) * 100;
    if (perc > 100) perc = 100; // La barra non esce fuori
    if (perc < 0) perc = 0;

    // Colore dinamico: Rosso se sei lontano, Verde se ci sei vicino
    let color = '#00b894'; // Verde
    if (perc < 30) color = '#d63031'; // Rosso
    else if (perc < 70) color = '#fdcb6e'; // Giallo

    // Aggiorna HTML
    document.getElementById('liquidityBar').style.width = perc + "%";
    document.getElementById('liquidityBar').style.background = color;
    
    // Testo
    const targetText = appData.liquidityTarget ? ` / ‚Ç¨${appData.liquidityTarget}` : " (Clicca per impostare)";
    document.getElementById('liquidityText').innerText = `Target: ‚Ç¨${targetText}`;
    document.getElementById('liquidityPerc').innerText = `${perc.toFixed(1)}% Raggiunto`;
}

// --- GESTIONE SKILLS (LOGICA QUANTITATIVA) ---

// Inizializza
if (!appData.skills) appData.skills = [];

function renderSkills() {
    const container = document.getElementById('skillsList');
    if (!container) return;
    container.innerHTML = '';

    if (appData.skills.length === 0) {
        container.innerHTML = '<div style="color:#666; text-align:center;">Nessun obiettivo attivo.</div>';
        return;
    }

    appData.skills.forEach(s => {
        // Calcolo percentuale matematica
        // (Attuale / Target) * 100. Massimo 100%.
        let perc = 0;
        if(s.target > 0) perc = (s.current / s.target) * 100;
        if(perc > 100) perc = 100;

        // Colore barra
        let color = '#ff7675'; // Rosso
        if (perc > 40) color = '#fdcb6e'; // Giallo
        if (perc >= 100) color = '#55efc4'; // Verde (Completato)

        container.innerHTML += `
            <div style="background: #1e1e24; padding: 15px; border-radius: 10px; border: 1px solid #333;">
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <div style="font-weight:bold; font-size:1.1rem;">${s.name}</div>
                    <div style="font-size:0.9rem; color:#aaa;">
                        <span style="color:white; font-weight:bold;">${s.current}</span> / ${s.target} ${s.unit}
                    </div>
                </div>

                <div style="background:#333; height:12px; border-radius:6px; overflow:hidden; margin-bottom:15px; position:relative;">
                    <div style="width:${perc}%; height:100%; background:${color}; transition: width 0.5s;"></div>
                    <div style="position:absolute; top:0; left:50%; transform:translateX(-50%); font-size:0.6rem; line-height:12px; color:white; text-shadow:0 0 2px black;">
                        ${perc.toFixed(1)}%
                    </div>
                </div>

                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="number" id="add_val_${s.id}" placeholder="Quantit√† fatta oggi" 
                           style="flex:1; padding:8px; border-radius:5px; border:1px solid #555; background:#111; color:white;">
                    
                    <button onclick="updateProgress(${s.id})" 
                            style="background:var(--accent); color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">
                        AGGIUNGI
                    </button>
                    
                    <button onclick="deleteSkill(${s.id})" 
                            style="background:none; border:1px solid #444; color:#666; padding:8px; border-radius:5px; cursor:pointer;">
                        üóëÔ∏è
                    </button>
                </div>

            </div>
        `;
    });
}

// 1. Aggiungi Nuova Skill
function addSkill() {
    const name = document.getElementById('skillName').value;
    const target = parseFloat(document.getElementById('skillTarget').value);
    const unit = document.getElementById('skillUnit').value || ''; // Opzionale

    if (name && target && target > 0) {
        appData.skills.push({
            id: Date.now(),
            name: name,
            target: target,  // Obiettivo finale (es. 300)
            current: 0,      // Si parte da 0
            unit: unit       // Es. 'pag', 'km', 'kg'
        });

        // Pulisci campi
        document.getElementById('skillName').value = '';
        document.getElementById('skillTarget').value = '';
        document.getElementById('skillUnit').value = '';
        
        saveData();
        renderSkills();
    } else {
        alert("Inserisci almeno il Nome e un Obiettivo numerico!");
    }
}

// 2. Aggiorna Progresso (Somma il valore)
function updateProgress(id) {
    const valInput = document.getElementById(`add_val_${id}`);
    const val = parseFloat(valInput.value);

    if (!isNaN(val)) {
        const skill = appData.skills.find(s => s.id === id);
        if (skill) {
            skill.current += val; // Somma al totale
            
            // (Opzionale) Se vuoi che non vada mai sotto zero:
            if(skill.current < 0) skill.current = 0;
            
            saveData();
            renderSkills();
        }
    }
}

// 3. Elimina
function deleteSkill(id) {
    if(confirm("Eliminare questo obiettivo?")) {
        appData.skills = appData.skills.filter(s => s.id !== id);
        saveData();
        renderSkills();
    }
}

// Avvia
renderSkills();

// --- FUNZIONI CALCOLATRICE ---

function toggleCalculator() {
    const body = document.getElementById('calcBody');
    // Se √® nascosto (none) o vuoto, mostralo. Altrimenti nascondilo.
    if (body.style.display === 'none' || body.style.display === '') {
        body.style.display = 'block';
    } else {
        body.style.display = 'none';
    }
}

function calcAppend(val) {
    const display = document.getElementById('calcDisplay');
    // Evita doppi operatori (es. ++ o //)
    const lastChar = display.value.slice(-1);
    const operators = ['+', '-', '*', '/'];
    
    if (operators.includes(val) && operators.includes(lastChar)) {
        // Sostituisce l'ultimo operatore se ne premi un altro
        display.value = display.value.slice(0, -1) + val;
    } else {
        display.value += val;
    }
}

function calcClear() {
    document.getElementById('calcDisplay').value = '';
}

function calcDelete() {
    const display = document.getElementById('calcDisplay');
    display.value = display.value.toString().slice(0, -1);
}

function calcCalculate() {
    const display = document.getElementById('calcDisplay');
    try {
        // eval() √® pericoloso in siti pubblici complessi, ma sicuro in una calc personale locale
        // Se c'√® un errore matematico (es. 9/0) il try-catch lo gestisce
        if(display.value) {
            display.value = eval(display.value);
        }
    } catch (e) {
        display.value = 'Error';
        setTimeout(() => display.value = '', 1500); // Cancella errore dopo 1.5s
    }
}

// --- INIZIALIZZAZIONE DATI SCUOLA (Aggiungi questo pezzo dentro INIT o appData) ---
    // Se appData.school non esiste (vecchi utenti), lo crea vuoto
    if (!appData.school) appData.school = [];

    // Chiama questa funzione dentro refreshUI() per aggiornare la grafica all'avvio
    // Esempio: function refreshUI() { ... renderSchool(); }
    
    // --- FUNZIONI REGISTRO SCOLASTICO ---

    function addGrade() {
    console.log("Tentativo di aggiunta voto...");

    // 1. AUTOCORREZIONE: Se la lista scuola non esiste, la creo ora.
    if (!appData.school) {
        console.log("Lista scuola mancante, la creo ora.");
        appData.school = [];
    }

    // 2. Prendo i valori
    const subInput = document.getElementById('subjectInput');
    const gradeInput = document.getElementById('gradeInput');
    const termInput = document.getElementById('termSelect');

    const subName = subInput.value.trim();
    const gradeVal = parseFloat(gradeInput.value);
    const term = parseInt(termInput.value);

    // 3. Controllo errori (Scrive un alert se manca qualcosa)
    if (!subName) {
        alert("Devi scrivere il nome della materia!");
        return;
    }
    if (isNaN(gradeVal)) {
        alert("Devi scrivere un voto valido (es. 7.5)");
        return;
    }

    // 4. Cerca se la materia esiste gi√†
    let subject = appData.school.find(s => s.name.toLowerCase() === subName.toLowerCase());

    if (!subject) {
        // Se non esiste, crea nuova materia
        subject = { id: Date.now(), name: subName, grades: [] };
        appData.school.push(subject);
    }

    // 5. Aggiungi il voto
    subject.grades.push({ 
        val: gradeVal, 
        term: term, 
        date: new Date().toLocaleDateString() 
    });

    console.log("Voto aggiunto!", subject);

    // 6. Pulisci input
    gradeInput.value = '';
    subInput.value = ''; 
    subInput.focus();

    // 7. SALVA E AGGIORNA (Fondamentale!)
    saveData();     // Salva nel database
    renderSchool(); // Disegna subito a schermo il risultato
}

    function removeGrade(subId, gradeIndex) {
        const subject = appData.school.find(s => s.id === subId);
        if (subject) {
            if(confirm("Rimuovere questo voto?")) {
                subject.grades.splice(gradeIndex, 1);
                // Se non ci sono pi√π voti, rimuovi la materia (opzionale, io lo lascerei per ordine)
                if (subject.grades.length === 0) {
                    appData.school = appData.school.filter(s => s.id !== subId);
                }
                saveData();
            }
        }
    }

    function renderSchool() {
    const container = document.getElementById('schoolList');
    const dl = document.getElementById('subjectListSuggestions');
    
    if (!container) return;

    container.innerHTML = '';
    dl.innerHTML = '';

    // Variabili per la Media Aritmetica Pura (Metodo Registro)
    let grandTotalSumQ1 = 0;
    let grandTotalCountQ1 = 0;
    let grandTotalSumQ2 = 0;
    let grandTotalCountQ2 = 0;

    if (appData.school) {
        appData.school.sort((a, b) => a.name.localeCompare(b.name));
    
        appData.school.forEach(sub => {
            dl.innerHTML += `<option value="${sub.name}">`;

            // Separiamo i voti
            const gradesQ1 = sub.grades.map((g, i) => ({...g, originalIndex: i})).filter(g => g.term === 1);
            const gradesQ2 = sub.grades.map((g, i) => ({...g, originalIndex: i})).filter(g => g.term === 2);

            // --- CALCOLO PER IL REGISTRO (Accumuliamo tutti i voti nel calderone generale) ---
            gradesQ1.forEach(g => { grandTotalSumQ1 += g.val; grandTotalCountQ1++; });
            gradesQ2.forEach(g => { grandTotalSumQ2 += g.val; grandTotalCountQ2++; });
            // ---------------------------------------------------------------------------------

            // Medie della singola materia (per visualizzazione riga)
            const avgQ1 = gradesQ1.length > 0 ? (gradesQ1.reduce((a, b) => a + b.val, 0) / gradesQ1.length) : 0;
            const avgQ2 = gradesQ2.length > 0 ? (gradesQ2.reduce((a, b) => a + b.val, 0) / gradesQ2.length) : 0;
            
            // Media Totale Materia (tutti i voti insieme)
            const allGrades = sub.grades;
            const subjectAvg = allGrades.length > 0 ? (allGrades.reduce((a, b) => a + b.val, 0) / allGrades.length) : 0;

            // Render dei pallini (Chips)
            const renderChips = (list) => list.map(g => 
                `<span onclick="removeGrade(${sub.id}, ${g.originalIndex})" 
                       style="cursor:pointer; font-size:0.8rem; padding:2px 6px; border-radius:4px; margin-right:4px; display:inline-block; margin-bottom:2px;
                       background:${g.val >= 6 ? 'rgba(0, 184, 148, 0.2)' : 'rgba(214, 48, 49, 0.2)'}; 
                       color:${g.val >= 6 ? '#00b894' : '#d63031'}; border:1px solid ${g.val >= 6 ? '#00b894' : '#d63031'};"
                       title="Clicca per eliminare">${g.val}</span>`
            ).join('');

            const colorQ1 = avgQ1 >= 6 ? '#00b894' : (avgQ1 > 0 ? '#d63031' : '#666');
            const colorQ2 = avgQ2 >= 6 ? '#00b894' : (avgQ2 > 0 ? '#d63031' : '#666');

            container.innerHTML += `
                <div style="background:#25252b; padding:15px; border-radius:8px; border-left: 4px solid #666; margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <div>
                            <span style="font-weight:bold; font-size:1.1rem; color:white;">${sub.name}</span>
                            <span style="margin-left:8px; font-size:0.8rem; color:#aaa;">(Med: ${subjectAvg > 0 ? subjectAvg.toFixed(2) : '-'})</span>
                             <button onclick="deleteSubject(${sub.id})" style="background:none; border:none; color:#444; font-size:0.8rem; cursor:pointer; margin-left:5px;">(x)</button>
                        </div>
                        <div style="font-family:'Courier New', monospace; font-size:0.9rem;">
                            <span style="color:#aaa;">Q1:</span><span style="color:${colorQ1}; font-weight:bold;">${avgQ1 > 0 ? avgQ1.toFixed(2) : '-'}</span>
                            <span style="color:#444; margin:0 5px;">|</span>
                            <span style="color:#aaa;">Q2:</span><span style="color:${colorQ2}; font-weight:bold;">${avgQ2 > 0 ? avgQ2.toFixed(2) : '-'}</span>
                        </div>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        <div style="display:flex; align-items:center;">
                            <span style="font-size:0.7rem; color:#666; width:25px;">Q1</span>
                            <div style="flex:1;">${gradesQ1.length ? renderChips(gradesQ1) : '<span style="font-size:0.7rem; color:#444;">...</span>'}</div>
                        </div>
                        <div style="display:flex; align-items:center;">
                            <span style="font-size:0.7rem; color:#666; width:25px;">Q2</span>
                            <div style="flex:1;">${gradesQ2.length ? renderChips(gradesQ2) : '<span style="font-size:0.7rem; color:#444;">...</span>'}</div>
                        </div>
                    </div>
                </div>
            `;
        });
    }

    // --- CALCOLO MEDIA GENERALE (ARITMETICA PURA) ---
    const finalAvgQ1 = grandTotalCountQ1 > 0 ? (grandTotalSumQ1 / grandTotalCountQ1) : 0;
    const finalAvgQ2 = grandTotalCountQ2 > 0 ? (grandTotalSumQ2 / grandTotalCountQ2) : 0;

    // Se Q2 √® vuoto, la media totale √® uguale a Q1 (non fare la media con 0!)
    let globalAvg = 0;
    if (finalAvgQ1 > 0 && finalAvgQ2 > 0) {
        // Se esistono entrambi i quadrimestri, facciamo la media tra tutte le somme diviso tutti i voti totali
        globalAvg = (grandTotalSumQ1 + grandTotalSumQ2) / (grandTotalCountQ1 + grandTotalCountQ2);
    } else if (finalAvgQ1 > 0) {
        globalAvg = finalAvgQ1;
    } else if (finalAvgQ2 > 0) {
        globalAvg = finalAvgQ2;
    }

    // Aggiorna i numerini in alto
    const elQ1 = document.getElementById('gpaQ1'); if(elQ1) elQ1.innerText = finalAvgQ1 > 0 ? finalAvgQ1.toFixed(2) : '-';
    const elQ2 = document.getElementById('gpaQ2'); if(elQ2) elQ2.innerText = finalAvgQ2 > 0 ? finalAvgQ2.toFixed(2) : '-';
    const elTot = document.getElementById('globalGpa'); if(elTot) elTot.innerText = globalAvg > 0 ? globalAvg.toFixed(2) : '0.0';
}
// --- FOCUS TIMER LOGIC (MULTI-TASK) ---
let focusInterval = null;
let focusSecondsLeft = 25 * 60;
let isFocusRunning = false;

// Aggiorna il display del timer
function updateFocusDisplay() {
    const m = Math.floor(focusSecondsLeft / 60);
    const s = focusSecondsLeft % 60;
    const timeString = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    
    document.getElementById('focusDisplay').innerText = timeString;
    
    if(isFocusRunning) document.title = `(${timeString}) Focus`;
    else document.title = 'SIA Manager';
}

// Funzioni per regolare il tempo (+5, -5 minuti)
function adjustTime(deltaMins) {
    if(isFocusRunning) return;
    let input = document.getElementById('focusDuration');
    let newVal = parseInt(input.value) + deltaMins;
    if(newVal < 1) newVal = 1;
    input.value = newVal;
    manualTimeSet();
}

function manualTimeSet() {
    if(isFocusRunning) return;
    const input = document.getElementById('focusDuration');
    let val = parseInt(input.value);
    if(isNaN(val) || val < 1) val = 25;
    focusSecondsLeft = val * 60;
    updateFocusDisplay();
}

// Start / Pausa / Reset
function startFocus() {
    if(isFocusRunning) return;
    isFocusRunning = true;
    
    document.getElementById('btnStartFocus').style.display = 'none';
    document.getElementById('btnPauseFocus').style.display = 'inline-block';
    document.getElementById('timerStatus').innerText = "üî• IN CORSO";
    document.getElementById('timerStatus').style.color = "var(--accent)";

    focusInterval = setInterval(() => {
        if(focusSecondsLeft > 0) {
            focusSecondsLeft--;
            updateFocusDisplay();
        } else {
            clearInterval(focusInterval);
            isFocusRunning = false;
            alert("‚è∞ Tempo Scaduto!");
            resetFocus();
        }
    }, 1000);
}

function pauseFocus() {
    clearInterval(focusInterval);
    isFocusRunning = false;
    document.getElementById('btnStartFocus').style.display = 'inline-block';
    document.getElementById('btnPauseFocus').style.display = 'none';
    document.getElementById('timerStatus').innerText = "‚è∏ PAUSA";
    document.getElementById('timerStatus').style.color = "var(--warning)";
}

function resetFocus() {
    pauseFocus();
    manualTimeSet(); // Ricarica il tempo dall'input
    document.getElementById('timerStatus').innerText = "PRONTO";
    document.getElementById('timerStatus').style.color = "#666";
    document.title = "SIA Manager";
}

// --- LOGICA LISTA OBIETTIVI ---

function addFocusTask() {
    const input = document.getElementById('newFocusTask');
    const text = input.value.trim();
    if(!text) return;

    const list = document.getElementById('focusTodoList');
    const id = Date.now(); // ID unico per il task

    const itemHTML = `
        <div id="task-${id}" style="background:#111; padding:10px; border-radius:6px; border:1px solid #333; display:flex; align-items:center; justify-content:space-between; animation: fadeIn 0.3s;">
            <div style="display:flex; align-items:center; gap:10px;">
                <input type="checkbox" onchange="toggleTask('${id}')" style="accent-color:var(--success); transform:scale(1.2); cursor:pointer;">
                <span class="task-text" style="color:white;">${text}</span>
            </div>
            <button onclick="deleteTask('${id}')" style="background:none; border:none; color:#666; cursor:pointer;">‚úï</button>
        </div>
    `;

    list.insertAdjacentHTML('beforeend', itemHTML);
    input.value = '';
    updateTaskCount();
}

function toggleTask(id) {
    const el = document.getElementById(`task-${id}`);
    const checkbox = el.querySelector('input[type="checkbox"]');
    const text = el.querySelector('.task-text');

    if(checkbox.checked) {
        text.style.textDecoration = "line-through";
        text.style.color = "#666";
        el.style.opacity = "0.6";
        el.style.borderColor = "var(--success)"; // Bordo verde quando fatto
    } else {
        text.style.textDecoration = "none";
        text.style.color = "white";
        el.style.opacity = "1";
        el.style.borderColor = "#333";
    }
}

function deleteTask(id) {
    const el = document.getElementById(`task-${id}`);
    el.remove();
    updateTaskCount();
}

function clearFocusList() {
    if(confirm("Vuoi cancellare tutta la lista?")) {
        document.getElementById('focusTodoList').innerHTML = '';
        updateTaskCount();
    }
}

function updateTaskCount() {
    const count = document.getElementById('focusTodoList').children.length;
    document.getElementById('tasksCount').innerText = `${count} obiettivi`;
}
</script>

</body>
</html>
