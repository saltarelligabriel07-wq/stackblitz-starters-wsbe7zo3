<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Manager - Auto Save</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #121214; --card: #1e1e24; --text: #fff; --accent: #6c5ce7; --success: #00b894; --danger: #d63031; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 80px; }
        .container { max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; border: 1px solid #333; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        h2 { margin-top: 0; color: #ccc; font-size: 1.1rem; border-bottom: 1px solid #333; padding-bottom: 10px; }
        input, select { background: #2d3436; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        button { cursor: pointer; border: none; padding: 10px; border-radius: 6px; font-weight: bold; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        .row { display: flex; gap: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        td, th { padding: 10px; text-align: left; border-bottom: 1px solid #333; }
        .wallet-display { font-size: 2.5rem; font-weight: 800; color: var(--success); font-family: 'Fira Code', monospace; margin: 10px 0; }
        
        /* STATUS BAR PER IL DEBUG */
        .status-bar {
            position: fixed; top: 0; left: 0; width: 100%; 
            background: #222; border-bottom: 1px solid #444; 
            padding: 5px 20px; font-size: 0.8rem; display: flex; 
            justify-content: space-between; align-items: center; z-index: 1000;
            box-sizing: border-box;
        }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body style="padding-top: 50px;"> <div class="status-bar">
    <div id="statusText"><span class="status-dot" style="background: gray;"></span> Controllo memoria...</div>
    <button onclick="forceSave()" style="padding: 2px 8px; font-size: 0.7rem; background: #444; color: white;">Forza Salvataggio</button>
</div>

<div class="container">

    <div class="card" style="border-left: 5px solid var(--success);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div><span style="color:#aaa;">SALDO</span><div class="wallet-display" id="displayWallet">‚Ç¨0.00</div></div>
            <div style="text-align: right;">
                <input type="number" id="manualWallet" placeholder="Modifica..." style="width: 100px; text-align: right;">
                <button onclick="updateWalletManual()" style="background: #333; color: white;">Salva</button>
            </div>
        </div>
        <div style="height: 200px; margin-top: 20px;"><canvas id="monthlyChart"></canvas></div>
    </div>

    <div class="card">
        <h2>üí∞ Aggiungi Movimento</h2>
        <div class="row">
            <input type="date" id="tDate">
            <select id="tCat">
                <option value="Cibo">üçï Cibo</option>
                <option value="Lavoro">üí∏ Lavoro (Entrata)</option>
                <option value="Svago">üéâ Svago</option>
                <option value="Casa">üè† Casa</option>
                <option value="Altro">üì¶ Altro</option>
            </select>
        </div>
        <div class="row">
            <input type="text" id="tDesc" placeholder="Descrizione" style="flex: 2;">
            <input type="number" id="tAmount" placeholder="‚Ç¨" style="flex: 1;">
        </div>
        <div class="row">
            <button onclick="addTransaction('income')" style="flex:1; background: var(--success); color: black;">+ ENTRATA</button>
            <button onclick="addTransaction('expense')" style="flex:1; background: var(--danger); color: white;">- SPESA</button>
        </div>
    </div>

    <div class="card">
        <h2>üìù Storico</h2>
        <table id="transTable"></table>
    </div>

</div>

<script>
    const DB_NAME = 'LifeManager_Fixed_V3'; // Nuovo nome per evitare conflitti vecchi
    let data = { wallet: 0.00, transactions: [] };
    let myChart = null;

    // --- SISTEMA DI SALVATAGGIO ---
    function saveData() {
        try {
            localStorage.setItem(DB_NAME, JSON.stringify(data));
            showStatus(true); // Mostra verde
            updateUI();
        } catch (e) {
            console.error(e);
            showStatus(false); // Mostra rosso
            alert("ATTENZIONE: Il browser sta bloccando il salvataggio! I dati andranno persi.");
        }
    }

    function loadData() {
        try {
            const saved = localStorage.getItem(DB_NAME);
            if (saved) {
                data = JSON.parse(saved);
                console.log("Dati caricati:", data);
            } else {
                console.log("Nessun dato precedente trovato. Inizio da zero.");
            }
            document.getElementById('tDate').valueAsDate = new Date();
            updateUI();
            showStatus(true);
        } catch (e) {
            console.error("Errore nel caricamento:", e);
            showStatus(false);
        }
    }

    // --- INDICATORE DI STATO ---
    function showStatus(isWorking) {
        const el = document.getElementById('statusText');
        if(isWorking) {
            el.innerHTML = '<span class="status-dot" style="background: #00b894;"></span> Memoria Attiva (Salvato)';
        } else {
            el.innerHTML = '<span class="status-dot" style="background: #d63031;"></span> ERRORE: Memoria non funzionante';
        }
    }
    
    function forceSave() {
        saveData();
        alert("Tentativo di salvataggio eseguito.");
    }

    // --- LOGICA UI ---
    function updateUI() {
        document.getElementById('displayWallet').innerText = '‚Ç¨' + parseFloat(data.wallet).toFixed(2);
        
        // Tabella
        const table = document.getElementById('transTable');
        table.innerHTML = '';
        data.transactions.slice().reverse().forEach((t, index) => {
            const realIndex = data.transactions.length - 1 - index;
            const color = t.type === 'income' ? 'var(--success)' : 'var(--danger)';
            const sign = t.type === 'income' ? '+' : '-';
            table.innerHTML += `
                <tr>
                    <td>${t.date}</td>
                    <td><b>${t.desc}</b> <small>(${t.cat})</small></td>
                    <td style="color:${color}; text-align:right;">${sign}‚Ç¨${t.amount}</td>
                    <td style="text-align:right;"><button onclick="deleteTrans(${realIndex})" style="color:#666; background:none;">x</button></td>
                </tr>`;
        });
        updateChart();
    }

    function updateChart() {
        const ctx = document.getElementById('monthlyChart').getContext('2d');
        let cats = {};
        data.transactions.forEach(t => {
            if (t.type === 'expense') cats[t.cat] = (cats[t.cat] || 0) + t.amount;
        });

        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(cats),
                datasets: [{ data: Object.values(cats), backgroundColor: ['#fdcb6e', '#00b894', '#6c5ce7', '#d63031', '#74b9ff'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });
    }

    // --- LOGICA DATI ---
    function updateWalletManual() {
        const val = parseFloat(document.getElementById('manualWallet').value);
        if(!isNaN(val)) { data.wallet = val; saveData(); document.getElementById('manualWallet').value=''; }
    }
    function addTransaction(type) {
        const desc = document.getElementById('tDesc').value;
        const amount = parseFloat(document.getElementById('tAmount').value);
        const cat = document.getElementById('tCat').value;
        const date = document.getElementById('tDate').value;
        if(desc && !isNaN(amount)) {
            data.transactions.push({ desc, amount, cat, type, date });
            type === 'income' ? data.wallet += amount : data.wallet -= amount;
            saveData();
            document.getElementById('tDesc').value = ''; document.getElementById('tAmount').value = '';
        }
    }
    function deleteTrans(index) {
        if(confirm("Eliminare?")) {
            const t = data.transactions[index];
            t.type === 'income' ? data.wallet -= t.amount : data.wallet += t.amount;
            data.transactions.splice(index, 1);
            saveData();
        }
    }

    // AVVIO
    window.onload = loadData;
</script>
</body>
</html>
